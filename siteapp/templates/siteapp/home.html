{% extends "siteapp/base.html" %}
{% load static %}

{% block title %}Home{% endblock %}

{% block content %}

<!-- ===========================================================
     TELESHOPPING SECTION
=========================================================== -->
<section class="live-section">

    {% if live_stream %}
    <div class="live-bar">
        <span class="live-dot"></span> LIVE NOW
    </div>
    {% endif %}

    <h2 class="section-title">TELESHOPPING — STREAMING NOW</h2>

    <!-- MAIN VIDEO -->
    <div class="video-container">
        {% if live_stream %}
            {{ live_stream.video_embed_code|safe }}
        {% elif active_video %}
            {{ active_video.embed_code|safe }}
        {% else %}
            <iframe class="live-video"
                src="https://www.youtube.com/embed/dQw4w9WgXcQ"
                allowfullscreen></iframe>
        {% endif %}
    </div>


    <!-- ===========================================================
         CHAT SYSTEM
    =========================================================== -->
    <div class="chat-wrapper">

        <h3 class="chat-title">LIVE CHAT</h3>

        <div id="chat-warning" class="chat-warning" style="display:none;">
            <strong>Join the chat!</strong><br>
            Enter your name + email to start sending messages.
        </div>

        <!-- MESSAGE FEED -->
        <div id="chat-feed" class="chat-feed">
            {% for msg in chat_messages %}
                <div class="chat-msg">
                    <span class="chat-time">{{ msg.created_at|date:"H:i:s" }}</span>
                    <span class="chat-text">{{ msg.text }}</span>
                </div>
            {% endfor %}
        </div>

        <!-- INPUT -->
        <div class="chat-input-row">
            <input 
                id="chat-input" 
                class="chat-input locked"
                type="text"
                placeholder="Ask about products, availability, or make an offer…"
                maxlength="200">
            <button id="chat-send" class="chat-send locked">SEND</button>
        </div>

    </div>

</section>
<!-- ===========================================================
     PREORDER BARGAINS TODAY!
=========================================================== -->
<!-- ===========================================================
     PREORDER BARGAINS TODAY!
=========================================================== -->
<section class="preorder-section">

    <!-- MATCH THE LIVESTREAM OUTER CONTAINER -->
    <div class="live-section" style="margin-top:40px;">

        <!-- FULL WIDTH BIG YELLOW BANNER -->
        <div class="preorder-big-banner">
            <h2>PRE-ORDER BARGAINS TODAY!</h2>

            <p>
                Pre-order from <strong>SPACE JUNK</strong>.<br>
                Email us directly:<br>
                <a href="mailto:sales@space-junk.biz" class="email-link">
                    sales@space-junk.biz
                </a>
            </p>

            <div class="preorder-big-tagline">
                LIMITED EDITION • BUY DIRECT • PRE-ORDER TODAY
            </div>
        </div>

        <!-- PRODUCT GRID -->
        <div class="product-grid">
            {% for item in shop_items %}
            <div class="product-card">

                <img src="{{ item.image.url }}" alt="{{ item.title }}">

                <div class="product-title">{{ item.title }}</div>

                <div class="product-description">{{ item.description }}</div>

                <div class="product-price">£{{ item.price }}</div>

                <a href="mailto:sales@space-junk.biz?subject=Pre-Order%20{{ item.title }}"
                class="product-buy">
                    BUY NOW VIA EMAIL
                </a>

            </div>
            {% empty %}
                <p style="text-align:center;font-weight:900;">
                    No products available right now.
                </p>
            {% endfor %}
        </div>

    </div>

</section>



<!-- ===========================================================
     SUBSCRIBE MODAL (required for chat)
=========================================================== -->
<div id="subscribeModal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <h3>Join the Chat</h3>

        <p class="modal-text">
            Enter your <strong>name</strong> and <strong>email</strong> to unlock live chat.
        </p>

        <input id="modalName" class="modal-input" type="text" placeholder="Your name (optional)">
        <input id="modalEmail" class="modal-input" type="email" placeholder="you@example.com">

        <button id="modalSubmit" class="modal-button">Continue</button>
    </div>
</div>



<!-- ===========================================================
     CHAT + MODAL JAVASCRIPT
=========================================================== -->
<script>
// ------------------------------
// LocalStorage
// ------------------------------
function loadSubscriber() {
    try { return JSON.parse(localStorage.getItem("sj_subscriber")); }
    catch { return null; }
}

function saveSubscriber(name, email) {
    localStorage.setItem("sj_subscriber", JSON.stringify({ name, email }));
}

window.SUBSCRIBER = loadSubscriber();

function isSubscribed() {
    return window.SUBSCRIBER && window.SUBSCRIBER.email;
}


// ------------------------------
// Lock / unlock UI visually
// ------------------------------
function updateChatLockState() {
    const input = document.getElementById("chat-input");
    const sendBtn = document.getElementById("chat-send");
    const warning = document.getElementById("chat-warning");

    if (!isSubscribed()) {
        input.classList.add("locked");
        sendBtn.classList.add("locked");
        warning.style.display = "block";
    } else {
        input.classList.remove("locked");
        sendBtn.classList.remove("locked");
        warning.style.display = "none";
    }
}

updateChatLockState();


// ------------------------------
// Force modal when clicking input or button
// ------------------------------
document.getElementById("chat-input").addEventListener("mousedown", function (e) {
    if (!isSubscribed()) {
        e.preventDefault();
        showModal();
    }
});

document.getElementById("chat-send").addEventListener("mousedown", function (e) {
    if (!isSubscribed()) {
        e.preventDefault();
        showModal();
    }
});

// Prevent typing
document.getElementById("chat-input").addEventListener("keydown", function (e) {
    if (!isSubscribed()) {
        e.preventDefault();
        showModal();
    }
});


// ------------------------------
// Modal controls
// ------------------------------
function showModal() {
    document.getElementById("subscribeModal").style.display = "flex";
}

function hideModal() {
    document.getElementById("subscribeModal").style.display = "none";
}

document.getElementById("modalSubmit").onclick = function () {
    const name = document.getElementById("modalName").value.trim();
    const email = document.getElementById("modalEmail").value.trim();

    if (!email) {
        alert("Please enter your email.");
        return;
    }

    fetch("/signup-email/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email })
    });

    saveSubscriber(name || "Guest", email);
    window.SUBSCRIBER = loadSubscriber();

    hideModal();
    updateChatLockState();
};


// ------------------------------
// Refresh chat
// ------------------------------
function refreshChat() {
    fetch("/chat/get/")
        .then(r => r.json())
        .then(data => {
            const feed = document.getElementById("chat-feed");
            const atBottom =
                feed.scrollTop + feed.clientHeight >= feed.scrollHeight - 10;

            feed.innerHTML = "";
            data.forEach(msg => {
                feed.innerHTML += `
                    <div class="chat-msg">
                        <span class="chat-time">${msg.time}</span>
                        <span class="chat-text">${msg.text}</span>
                    </div>
                `;
            });

            if (atBottom) feed.scrollTop = feed.scrollHeight;
        });
}

setInterval(refreshChat, 1000);


// ------------------------------
// Sending messages
// ------------------------------
function sendMessage() {
    if (!isSubscribed()) {
        showModal();
        return;
    }

    const input = document.getElementById("chat-input");
    const text = input.value.trim();
    if (!text) return;

    fetch("/chat/post/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            name: window.SUBSCRIBER.name,
            email: window.SUBSCRIBER.email,
            text: text
        })
    }).then(() => {
        input.value = "";
        refreshChat();
    });
}

document.getElementById("chat-send").onclick = sendMessage;
document.getElementById("chat-input").addEventListener("keyup", e => {
    if (e.key === "Enter") sendMessage();
});
</script>

{% endblock %}
